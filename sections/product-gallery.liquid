{% comment %}
SECTION : Galerie produit "Instant Switch" (Zéro latence - Empilement CSS)
{% endcomment %}

<div class="product-gallery-section">
  <div class="product-gallery-container">
    
    <div class="main-image-wrapper">
      
      {% for i in (1..6) %}
        {% assign image_key = 'image_' | append: i %}
        {% if section.settings[image_key] %}
          <img 
            src="{{ section.settings[image_key] | img_url: '1000x' }}" 
            alt="Image produit {{ i }}"
            class="main-image {% if i == 1 %}active{% endif %}"
            data-index="{{ i }}"
          >
        {% endif %}
      {% endfor %}
      
      <button class="gallery-nav gallery-nav-prev" onclick="changeImage('prev')" aria-label="Image précédente">
        ‹
      </button>
      <button class="gallery-nav gallery-nav-next" onclick="changeImage('next')" aria-label="Image suivante">
        ›
      </button>
    </div>

    <div class="thumbnails-wrapper">
      <div class="thumbnails-container">
        
        {% for i in (1..6) %}
          {% assign image_key = 'image_' | append: i %}
          {% if section.settings[image_key] %}
            <div class="thumbnail {% if i == 1 %}active{% endif %}" 
                 onclick="selectImage({{ i }})"
                 data-index="{{ i }}">
              <img 
                src="{{ section.settings[image_key] | img_url: '200x' }}" 
                alt="Miniature {{ i }}"
              >
            </div>
          {% endif %}
        {% endfor %}

      </div>
    </div>

  </div>
</div>

<style>
/* CONTAINER PRINCIPAL */
.product-gallery-section {
  padding: 0;
  margin: 0;
  background: #ffffff;
}

.product-gallery-container {
  max-width: 800px;
  margin: 0 auto;
  padding: 0 20px;
}

/* GRANDE IMAGE - SYSTÈME D'EMPILEMENT */
.main-image-wrapper {
  position: relative;
  width: 100%;
  margin-bottom: 10px; 
  background: #ffffff;
  border-radius: 0px !important;
  overflow: hidden;
  /* On force le carré pour que le conteneur tienne la place */
  aspect-ratio: 1 / 1; 
}

.main-image {
  position: absolute; /* Les images se superposent */
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  display: block;
  object-fit: contain; 
  opacity: 0; /* Cachée par défaut */
  transition: opacity 0.4s ease-in-out; /* Transition douce pure CSS */
  z-index: 1;
  background: #fff;
}

/* L'image active devient visible */
.main-image.active {
  opacity: 1;
  z-index: 2;
}

/* FLÈCHES DE NAVIGATION */
.gallery-nav {
  position: absolute;
  top: 50%;
  transform: translateY(-50%);
  background: rgba(255, 255, 255, 0.9);
  color: #000;
  border: 1px solid #eee;
  width: 40px;
  height: 40px;
  border-radius: 50%;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 24px;
  z-index: 10; /* Au dessus des images */
  transition: all 0.2s ease;
  padding-bottom: 4px;
}

.gallery-nav:hover {
  background: #000C7D;
  color: #fff;
  border-color: #000C7D;
}

.gallery-nav-prev { left: 15px; }
.gallery-nav-next { right: 15px; }

/* MINIATURES */
.thumbnails-wrapper {
  overflow-x: auto;
  scrollbar-width: none;
  padding: 5px 0 15px 0; 
}
.thumbnails-wrapper::-webkit-scrollbar { display: none; }

.thumbnails-container {
  display: flex;
  gap: 12px;
  justify-content: center;
  flex-wrap: wrap; 
}

.thumbnail {
  flex-shrink: 0;
  width: 80px;
  height: 80px;
  cursor: pointer;
  border: 2px solid #eee;
  border-radius: 0px !important;
  transition: all 0.2s ease;
  overflow: hidden;
  background: #fff;
}

.thumbnail img {
  width: 100%;
  height: 100%;
  object-fit: contain;
  display: block;
  padding: 2px;
}

.thumbnail:hover {
  border-color: #000C7D;
  opacity: 1;
}

.thumbnail.active {
  border-color: #000C7D;
  border-width: 2px;
}

/* RESPONSIVE MOBILE */
@media (max-width: 768px) {
  .product-gallery-section { padding: 0; }
  .product-gallery-container { padding: 0; max-width: 100%; }
  
  .thumbnails-container {
    justify-content: flex-start;
    flex-wrap: nowrap;
    padding: 10px;
  }
  .thumbnail { width: 70px; height: 70px; }
}
</style>

<script>
let currentImageIndex = 1;
// Compte combien d'images existent réellement dans le HTML
const totalImages = document.querySelectorAll('.main-image').length;

function selectImage(index) {
  if(index > totalImages || index < 1) return;
  currentImageIndex = index;
  
  // 1. GESTION IMAGES PRINCIPALES (CSS class swap = instantané)
  document.querySelectorAll('.main-image').forEach(img => {
    img.classList.remove('active');
  });
  
  const targetImg = document.querySelector(`.main-image[data-index="${index}"]`);
  if(targetImg) targetImg.classList.add('active');
  
  // 2. GESTION MINIATURES
  document.querySelectorAll('.thumbnail').forEach(thumb => {
    thumb.classList.remove('active');
  });
  
  const activeThumb = document.querySelector(`.thumbnail[data-index="${index}"]`);
  if(activeThumb) activeThumb.classList.add('active');
}

function changeImage(direction) {
  if(totalImages === 0) return;

  if (direction === 'prev') {
    currentImageIndex = currentImageIndex > 1 ? currentImageIndex - 1 : totalImages;
  } else {
    currentImageIndex = currentImageIndex < totalImages ? currentImageIndex + 1 : 1;
  }
  
  selectImage(currentImageIndex);
}
</script>

{% schema %}
{
  "name": "Galerie Produit",
  "settings": [
    {
      "type": "header",
      "content": "Images de la galerie"
    },
    {
      "type": "image_picker",
      "id": "image_1",
      "label": "Image 1 (Principale)"
    },
    {
      "type": "image_picker",
      "id": "image_2",
      "label": "Image 2"
    },
    {
      "type": "image_picker",
      "id": "image_3",
      "label": "Image 3"
    },
    {
      "type": "image_picker",
      "id": "image_4",
      "label": "Image 4"
    },
    {
      "type": "image_picker",
      "id": "image_5",
      "label": "Image 5"
    },
    {
      "type": "image_picker",
      "id": "image_6",
      "label": "Image 6"
    }
  ],
  "presets": [
    {
      "name": "Galerie Produit"
    }
  ]
}
{% endschema %}