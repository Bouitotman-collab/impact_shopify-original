{% comment %}
SECTION : Galerie produit avec grande image + 6 miniatures (Format Carré - Non coupé)
{% endcomment %}

<div class="product-gallery-section">
  <div class="product-gallery-container">
    
    <div class="main-image-wrapper">
      <img 
        id="mainImage" 
        src="{{ section.settings.image_1 | img_url: '1000x' }}" 
        alt="Image produit principale"
        class="main-image"
      >
      
      <button class="gallery-nav gallery-nav-prev" onclick="changeImage('prev')" aria-label="Image précédente">
        ‹
      </button>
      <button class="gallery-nav gallery-nav-next" onclick="changeImage('next')" aria-label="Image suivante">
        ›
      </button>
    </div>

    <div class="thumbnails-wrapper">
      <div class="thumbnails-container">
        
        {% for i in (1..6) %}
          {% assign image_key = 'image_' | append: i %}
          {% if section.settings[image_key] %}
            <div class="thumbnail {% if i == 1 %}active{% endif %}" 
                 onclick="selectImage({{ i }}, '{{ section.settings[image_key] | img_url: '1000x' }}')"
                 data-index="{{ i }}">
              <img 
                src="{{ section.settings[image_key] | img_url: '200x' }}" 
                alt="Miniature {{ i }}"
              >
            </div>
          {% endif %}
        {% endfor %}

      </div>
    </div>

  </div>
</div>

<style>
/* CONTAINER PRINCIPAL */
.product-gallery-section {
  padding: 40px 0;
  background: #ffffff;
}

.product-gallery-container {
  max-width: 800px;
  margin: 0 auto;
  padding: 0 20px;
}

/* GRANDE IMAGE */
.main-image-wrapper {
  position: relative;
  width: 100%;
  margin-bottom: 20px;
  background: #ffffff;
  border-radius: 8px;
  overflow: hidden;
  /* Optionnel : petite ombre pour le relief */
  box-shadow: 0 4px 12px rgba(0,0,0,0.05); 
}

.main-image {
  width: 100%;
  height: auto;
  display: block;
  /* C'est ici que la magie opère : Format Carré (1/1) + Image entière (contain) */
  aspect-ratio: 1 / 1; 
  object-fit: contain; 
}

/* FLÈCHES DE NAVIGATION */
.gallery-nav {
  position: absolute;
  top: 50%;
  transform: translateY(-50%);
  background: rgba(255, 255, 255, 0.9); /* Fond blanc semi-transparent plus moderne */
  color: #000;
  border: 1px solid #eee;
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  width: 40px;
  height: 40px;
  border-radius: 50%;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 24px;
  z-index: 10;
  transition: all 0.2s ease;
  padding-bottom: 4px; /* Ajustement visuel de la flèche */
}

.gallery-nav:hover {
  background: #000C7D;
  color: #fff;
  border-color: #000C7D;
}

.gallery-nav-prev { left: 15px; }
.gallery-nav-next { right: 15px; }

/* MINIATURES */
.thumbnails-wrapper {
  overflow-x: auto;
  scrollbar-width: none; /* Firefox */
  padding: 5px; /* Espace pour l'ombre éventuelle */
}

.thumbnails-wrapper::-webkit-scrollbar { display: none; /* Chrome/Safari */ }

.thumbnails-container {
  display: flex;
  gap: 12px;
  justify-content: center;
  flex-wrap: wrap; 
}

.thumbnail {
  flex-shrink: 0;
  width: 80px;
  height: 80px;
  cursor: pointer;
  border: 2px solid #eee; /* Bordure grise par défaut */
  border-radius: 6px;
  transition: all 0.2s ease;
  overflow: hidden;
  background: #fff;
}

.thumbnail img {
  width: 100%;
  height: 100%;
  object-fit: contain; /* Miniature entière aussi */
  display: block;
  padding: 2px;
}

.thumbnail:hover {
  border-color: #000C7D;
  opacity: 1;
}

.thumbnail.active {
  border-color: #000C7D;
  border-width: 2px;
}

/* RESPONSIVE MOBILE */
@media (max-width: 768px) {
  .product-gallery-section {
    padding: 20px 0;
  }
  
  .product-gallery-container {
    padding: 0 15px;
  }

  /* Sur mobile, on garde le carré 1/1 */
  .main-image {
    aspect-ratio: 1 / 1; 
  }

  .thumbnails-container {
    justify-content: flex-start; /* Aligné à gauche pour scroller */
    flex-wrap: nowrap; /* Force le scroll horizontal */
    padding-bottom: 10px;
  }
  
  .thumbnail {
    width: 70px;
    height: 70px;
  }
}
</style>

<script>
let currentImageIndex = 1;
const totalImages = {{ section.blocks.size | default: 6 }};

// On stocke les URLs
const imageUrls = [
  {% for i in (1..6) %}
    {% assign image_key = 'image_' | append: i %}
    {% if section.settings[image_key] %}
      "{{ section.settings[image_key] | img_url: '1000x' }}"{% unless forloop.last %},{% endunless %}
    {% endif %}
  {% endfor %}
];

// Sélectionner une image via miniature
function selectImage(index, imageUrl) {
  currentImageIndex = index;
  
  // Changer l'image principale
  const mainImg = document.getElementById('mainImage');
  mainImg.style.opacity = '0.8'; // Petit effet de transition
  
  setTimeout(() => {
    mainImg.src = imageUrl;
    mainImg.style.opacity = '1';
  }, 150);
  
  // Mettre à jour les miniatures actives
  document.querySelectorAll('.thumbnail').forEach(thumb => {
    thumb.classList.remove('active');
  });
  
  const activeThumb = document.querySelector(`.thumbnail[data-index="${index}"]`);
  if(activeThumb) activeThumb.classList.add('active');
}

// Navigation flèches
function changeImage(direction) {
  // Calculer le nombre réel d'images chargées
  const realTotalImages = imageUrls.length;
  if(realTotalImages === 0) return;

  if (direction === 'prev') {
    currentImageIndex = currentImageIndex > 1 ? currentImageIndex - 1 : realTotalImages;
  } else {
    currentImageIndex = currentImageIndex < realTotalImages ? currentImageIndex + 1 : 1;
  }
  
  // L'index du tableau commence à 0, donc on fait -1
  selectImage(currentImageIndex, imageUrls[currentImageIndex - 1]);
}
</script>

{% schema %}
{
  "name": "Galerie Produit",
  "settings": [
    {
      "type": "header",
      "content": "Images de la galerie"
    },
    {
      "type": "paragraph",
      "content": "Pour un résultat optimal, utilisez des images carrées (ex: 1000x1000px)."
    },
    {
      "type": "image_picker",
      "id": "image_1",
      "label": "Image 1 (Principale)"
    },
    {
      "type": "image_picker",
      "id": "image_2",
      "label": "Image 2"
    },
    {
      "type": "image_picker",
      "id": "image_3",
      "label": "Image 3"
    },
    {
      "type": "image_picker",
      "id": "image_4",
      "label": "Image 4"
    },
    {
      "type": "image_picker",
      "id": "image_5",
      "label": "Image 5"
    },
    {
      "type": "image_picker",
      "id": "image_6",
      "label": "Image 6"
    }
  ],
  "presets": [
    {
      "name": "Galerie Produit"
    }
  ]
}
{% endschema %}