{%- render 'section-spacing-collapsing' -%}

<style>
  #shopify-section-{{ section.id }} {
    --product-grid: auto / minmax(0, 1fr);
    --product-gallery-media-list-grid: auto / auto-flow {% if section.settings.mobile_carousel_control == 'free_scroll' %}{% if section.settings.mobile_media_size == 'expanded' %}84vw{% else %}73vw{% endif %}{% else %}100%{% endif %};
    --product-gallery-media-list-gap: {% if section.settings.mobile_media_size == 'expanded' %}var(--spacing-0-5){% else %}var(--grid-gutter){% endif %};
  }

  @media screen and (max-width: 999px) {
    #shopify-section-{{ section.id }} {
      --section-spacing-block-start: {% if section.settings.mobile_media_size == 'expanded' %}0px{% else %}var(--container-gutter){% endif %};
    }
  }

  @media screen and (min-width: 1000px) {
    #shopify-section-{{ section.id }} {
    {%- assign media_ratio = section.settings.desktop_media_width | divided_by: 50.0 -%}
      --product-grid: auto / minmax(0, {{ media_ratio }}fr) minmax(0, {{ 2.0 | minus: media_ratio }}fr);
      --product-gallery-media-list-grid: {% if section.settings.desktop_media_layout contains 'grid' %}auto-flow dense / repeat({% if section.settings.desktop_media_layout == 'grid_one' %}1{% else %}2{% endif %}, minmax(0, 1fr)){% else %}auto / auto-flow 100%{% endif %};
      --product-gallery-media-list-gap: calc(var(--grid-gutter) / 2);
    }

  {%- if section.settings.desktop_media_layout == 'grid_highlight' -%}
    #shopify-section-{{ section.id }} .product-gallery__media-list > :not([hidden]) {
      grid-column: span 2;
    }

    #shopify-section-{{ section.id }} .product-gallery__media-list > :not([hidden]) ~ *:not(.product-gallery__media--expand) {
      grid-column: span 1;
    }
  {%- endif -%}
  }

  @media screen and (min-width: 1400px) {
    #shopify-section-{{ section.id }} {
      --product-gallery-media-list-gap: var(--grid-gutter);
    }
  }

  /* ===== PERSONNALISATION MINIATURES - VERSION SÛRE ===== */
  
  /* Afficher seulement 3 miniatures */
  #shopify-section-{{ section.id }} .product-gallery__thumbnail:nth-child(n+4) {
    display: none !important;
  }

  /* Miniatures carrées plus grandes sans bordure par défaut */
  #shopify-section-{{ section.id }} .product-gallery__thumbnail {
    width: 135px !important; /* Augmenté de 125px à 135px */
    height: 135px !important;
    min-width: 135px !important;
    border: none !important;
    border-radius: 16px !important;
    overflow: hidden !important;
  }

  /* Bordure noire TRÈS FINE sur miniature sélectionnée */
  #shopify-section-{{ section.id }} .product-gallery__thumbnail[aria-current="true"],
  #shopify-section-{{ section.id }} .product-gallery__thumbnail.is-selected,
  #shopify-section-{{ section.id }} .product-gallery__thumbnail.is-active {
    border: 1px solid #000 !important; /* Ultra-fin : 1px */
    padding: 2px !important;
  }

  /* Image dans miniature */
  #shopify-section-{{ section.id }} .product-gallery__thumbnail img {
    width: 100% !important;
    height: 100% !important;
    object-fit: cover !important;
    border-radius: 13px !important;
  }

  /* Conteneur des miniatures - padding très réduit */
  #shopify-section-{{ section.id }} .product-gallery__thumbnail-list {
    display: flex !important;
    gap: 16px !important;
    padding: 5px 50px !important; /* Réduit de 10px à 5px */
    justify-content: center !important;
  }

  /* Flèches de navigation - style simple */
  #shopify-section-{{ section.id }} .product-gallery [data-direction="previous"],
  #shopify-section-{{ section.id }} .product-gallery [data-direction="next"] {
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    background: transparent !important;
    border: none !important;
    width: 30px !important;
    height: 30px !important;
    cursor: pointer !important;
    position: absolute !important;
    top: 50% !important;
    transform: translateY(-50%) !important;
    z-index: 10 !important;
  }

  #shopify-section-{{ section.id }} .product-gallery [data-direction="previous"] {
    left: -10px !important; /* Sortie du container */
  }

  #shopify-section-{{ section.id }} .product-gallery [data-direction="next"] {
    right: -10px !important; /* Sortie du container */
  }

  #shopify-section-{{ section.id }} .product-gallery [data-direction] svg {
    color: #000 !important;
    stroke: #000 !important;
    stroke-width: 3px !important;
    width: 24px !important;
    height: 24px !important;
  }

  /* Responsive - Mobile */
  @media screen and (max-width: 999px) {
    #shopify-section-{{ section.id }} .product-gallery__thumbnail {
      width: 105px !important; /* Augmenté de 100px à 105px */
      height: 105px !important;
      min-width: 105px !important;
    }
    
    #shopify-section-{{ section.id }} .product-gallery__thumbnail-list {
      padding: 3px 40px !important; /* Réduit également sur mobile */
      gap: 12px !important;
    }
  }

  /* Responsive - Desktop */
  @media screen and (min-width: 1000px) {
    #shopify-section-{{ section.id }} .product-gallery__thumbnail {
      width: 155px !important; /* Augmenté de 145px à 155px */
      height: 155px !important;
    }
    
    #shopify-section-{{ section.id }} .product-gallery__thumbnail-list {
      gap: 20px !important;
    }
  }

  /* Style pour les flèches personnalisées */
  #shopify-section-{{ section.id }} .custom-arrow {
    position: absolute !important;
    top: 50% !important;
    transform: translateY(-50%) !important;
    width: 30px !important;
    height: 30px !important;
    background: transparent !important;
    border: none !important;
    cursor: pointer !important;
    z-index: 10 !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
  }

  #shopify-section-{{ section.id }} .custom-arrow-prev {
    left: -20px !important; /* Très écarté vers la gauche */
  }

  #shopify-section-{{ section.id }} .custom-arrow-next {
    right: -20px !important; /* Très écarté vers la droite */
  }

  #shopify-section-{{ section.id }} .custom-arrow svg {
    width: 24px !important;
    height: 24px !important;
    stroke: #000 !important;
    stroke-width: 2.5px !important;
  }

  #shopify-section-{{ section.id }} .custom-arrow:hover {
    transform: translateY(-50%) scale(1.2) !important;
  }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const section = document.querySelector('#shopify-section-{{ section.id }}');
  if (!section) return;
  
  const thumbList = section.querySelector('.product-gallery__thumbnail-list');
  if (!thumbList || thumbList.querySelector('.custom-arrow')) return;
  
  const wrapper = thumbList.parentElement;
  wrapper.style.position = 'relative';
  
  // Créer flèche gauche
  const prevArrow = document.createElement('button');
  prevArrow.className = 'custom-arrow custom-arrow-prev';
  prevArrow.innerHTML = '<svg viewBox="0 0 24 24" fill="none"><polyline points="15 18 9 12 15 6"></polyline></svg>';
  prevArrow.setAttribute('aria-label', 'Image précédente');
  
  // Créer flèche droite
  const nextArrow = document.createElement('button');
  nextArrow.className = 'custom-arrow custom-arrow-next';
  nextArrow.innerHTML = '<svg viewBox="0 0 24 24" fill="none"><polyline points="9 18 15 12 9 6"></polyline></svg>';
  nextArrow.setAttribute('aria-label', 'Image suivante');
  
  wrapper.appendChild(prevArrow);
  wrapper.appendChild(nextArrow);
  
  const thumbnails = Array.from(thumbList.querySelectorAll('.product-gallery__thumbnail'));
  let currentIndex = 0;
  
  function updateVisibility() {
    thumbnails.forEach((thumb, i) => {
      thumb.style.display = (i >= currentIndex && i < currentIndex + 3) ? 'block' : 'none';
    });
    prevArrow.style.opacity = currentIndex === 0 ? '0.3' : '1';
    nextArrow.style.opacity = currentIndex >= thumbnails.length - 3 ? '0.3' : '1';
  }
  
  prevArrow.addEventListener('click', function() {
    if (currentIndex > 0) {
      currentIndex--;
      updateVisibility();
    }
  });
  
  nextArrow.addEventListener('click', function() {
    if (currentIndex < thumbnails.length - 3) {
      currentIndex++;
      updateVisibility();
    }
  });
  
  if (thumbnails.length > 3) updateVisibility();
});
</script>

<div {% render 'section-properties', tight: true %}>
  {%- capture product_form_id -%}featured-product-form-{{ section.id }}{%- endcapture -%}

  <product-rerender id="featured-product-{{ section.id }}" observe-form="{{ product_form_id }}" allow-partial-rerender>
    <div class="product">
      {%- if section.settings.product != blank -%}
        {%- if section.settings.product.media.size > 0 -%}
          {%- render 'product-gallery', product: section.settings.product, product_form_id: product_form_id -%}
        {%- endif -%}

        {%- render 'product-info', 
          product: section.settings.product, 
          product_form_id: product_form_id, 
          update_url: false,
          context: 'featured_product'
        -%}
      {%- else -%}
        <product-gallery form="placeholder-{{ section.id }}" class="product-gallery {% if section.settings.mobile_carousel_control contains 'dots' %}product-gallery--mobile-dots{% endif %} {% if section.settings.desktop_media_layout contains 'grid' %}product-gallery--desktop-grid{% else %}product-gallery--desktop-carousel{% endif %} {% if section.settings.desktop_media_layout == 'carousel_thumbnails_left' %}product-gallery--desktop-thumbnails-left{% endif %} {% if section.settings.mobile_media_size == 'expanded' %}product-gallery--mobile-expanded{% endif %}">
          <div class="product-gallery__ar-wrapper">
            <div class="product-gallery__media-list-wrapper">

              <media-carousel desktop-mode="{{ section.settings.desktop_media_layout }}" adaptive-height class="product-gallery__media-list {% if section.settings.mobile_media_size == 'expanded' %}full-bleed{% else %}bleed{% endif %} scroll-area md:unbleed">
                <div class="product-gallery__media {% if section.settings.mobile_carousel_control != 'free_scroll' %}snap-center{% endif %}">
                  {{- 'product-1' | placeholder_svg_tag: 'placeholder rounded' -}}
                </div>
              </media-carousel>
            </div>
          </div>
        </product-gallery>

        <safe-sticky class="product-info">
          {%- for block in section.blocks -%}
            {%- case block.type -%}
              {%- when 'vendor' -%}
                <div class="product-info__vendor" {{ block.shopify_attributes }}>{{- 'general.on_boarding.product_vendor' | t -}}</div>

              {%- when 'title' -%}
                <h2 class="product-info__title {{ block.settings.heading_tag }}" {{ block.shopify_attributes }}>{{ 'general.on_boarding.product_title' | t }}</h2>

              {%- when 'price' -%}
                <div class="product-info__price">
                  <price-list class="price-list price-list--lg">
                    <sale-price class="text-lg">{{ 4000 | money }}</sale-price>
                  </price-list>
                </div>

              {%- when 'separator' -%}
                <hr class="product-info__separator" {{ block.shopify_attributes }}>

              {%- when 'description' -%}
                <div class="product-info__description" {{ block.shopify_attributes }}>
                  <div class="prose">
                    {{- 'general.on_boarding.product_description' | t -}}
                  </div>
                </div>

              {%- when 'quantity_selector' -%}
                <div class="product-info__quantity-selector {{ block.shopify_attributes }}">
                  {%- assign variant = section.settings.product.selected_or_first_available_variant -%}

                  <div class="form-control">
                    <label for="{{ product_form_id }}-quantity" class="block-label text-subdued">{{- 'product.quantity.label' | t -}}:</label>

                    <quantity-selector class="quantity-selector">
                      <button type="button" class="quantity-selector__button" aria-label="{{ 'product.quantity.decrease_quantity' | t }}">{% render 'icon' with 'minus', width: 10, height: 2 %}</button>
                      <input id="{{ product_form_id }}-quantity" type="number" is="quantity-input" inputmode="numeric" class="quantity-selector__input" name="quantity" form="{{ product_form_id }}" value="{{ variant.quantity_rule.min | default: 1 }}" step="{{ variant.quantity_rule.increment }}" min="{{ variant.quantity_rule.min }}" {% if variant.quantity_rule.max != nil %}max="{{ variant.quantity_rule.max }}"{% endif %} autocomplete="off">
                      <button type="button" class="quantity-selector__button" aria-label="{{ 'product.quantity.increase_quantity' | t }}">{% render 'icon' with 'plus', width: 10, height: 10 %}</button>
                    </quantity-selector>
                  </div>

                  {%- liquid
                    assign quantity_rules = ''
    
                    if variant.quantity_rule.min > 1
                      assign rule = 'product.quantity.minimum_of' | t: min: variant.quantity_rule.min
                      assign quantity_rules = quantity_rules | append: ' / ' | append: rule
                    endif
    
                    if variant.quantity_rule.max != nil
                      assign rule = 'product.quantity.maximum_of' | t: max: variant.quantity_rule.max
                      assign quantity_rules = quantity_rules | append: ' / ' | append: rule
                    endif
    
                    if variant.quantity_rule.increment > 1
                      assign rule = 'product.quantity.increment_of' | t: step: variant.quantity_rule.increment
                      assign quantity_rules = quantity_rules | append: ' / ' | append: rule
                    endif
                  -%}
    
                  {%- if quantity_rules != blank -%}
                    <p class="text-subdued text-sm">{{ quantity_rules | remove_first: ' / ' | capitalize }}</p>
                  {%- endif -%}
                </div>

              {%- when 'buy_buttons' -%}
                <div class="product-info__buy-buttons" {{ block.shopify_attributes }}>
                  <buy-buttons class="buy-buttons">
                    {%- capture button_content -%}{{ 'product.general.add_to_cart_button' | t }}{%- endcapture -%}
                    {%- render 'button', content: button_content, type: 'submit', size: 'xl', background: block.settings.atc_button_background, text_color: block.settings.atc_button_text_color -%}
                  </buy-buttons>
                </div>
            {%- endcase -%}
          {%- endfor -%}
        </safe-sticky>
      {%- endif -%}
    </div>
  </product-rerender>
</div>

{% schema %}
{
  "name": "Featured product",
  "class": "shopify-section--featured-product",
  "tag": "section",
  "disabled_on": {
    "templates": ["password"],
    "groups": ["header", "custom.overlay"]
  },
  "blocks": [
    {
      "type": "@app"
    },
    {
      "type": "vendor",
      "name": "Vendor",
      "limit": 1
    },
    {
      "type": "title",
      "name": "Title",
      "limit": 1,
      "settings": [
        {
          "type": "select",
          "id": "heading_tag",
          "label": "Style",
          "options": [
            {
              "value": "h1",
              "label": "X-Large"
            },
            {
              "value": "h2",
              "label": "Large"
            },
            {
              "value": "h3",
              "label": "Medium"
            },
            {
              "value": "h4",
              "label": "Small"
            },
            {
              "value": "h5",
              "label": "X-Small"
            },
            {
              "value": "h6",
              "label": "XX-Small"
            }
          ],
          "default": "h2"
        }
      ]
    },
    {
      "type": "sku",
      "name": "SKU",
      "limit": 1
    },
    {
      "type": "badges",
      "name": "Badges",
      "limit": 1,
      "settings": [
        {
          "type": "paragraph",
          "content": "Use metafields to add custom badges. [Learn more](https://support.maestrooo.com/article/75-collection-displaying-custom-label)"
        }
      ]
    },
    {
      "type": "price",
      "name": "Price",
      "limit": 1,
      "settings": [
        {
          "type": "checkbox",
          "id": "show_taxes_notice",
          "label": "Show taxes notice",
          "default": false
        }
      ]
    },
    {
      "type": "payment_terms",
      "name": "Payment installments",
      "limit": 1,
      "settings": [
        {
          "type": "paragraph",
          "content": "To display payment installments, your store needs to support Shop Pay Installments. [Learn more](https://help.shopify.com/en/manual/payments/shop-pay-installments)"
        }
      ]
    },
    {
      "type": "rating",
      "name": "Rating",
      "limit": 1,
      "settings": [
        {
          "type": "paragraph",
          "content": "To display a rating, add a product rating app. [Learn more](https://apps.shopify.com/categories/store-design-social-proof-product-reviews)"
        },
        {
          "type": "checkbox",
          "id": "show_empty",
          "label": "Show if no reviews",
          "default": false
        }
      ]
    },
    {
      "type": "separator",
      "name": "Separator"
    },
    {
      "type": "description",
      "name": "Description",
      "limit": 1,
      "settings": [
        {
          "type": "select",
          "id": "icon",
          "label": "Icon",
          "options": [
            {
              "value": "none",
              "label": "None"
            },
            {
              "value": "picto-coupon",
              "label": "Coupon",
              "group": "Shop"
            }
          ],
          "default": "none"
        },
        {
          "type": "image_picker",
          "id": "custom_icon",
          "label": "Custom icon",
          "info": "96 x 96px .png or .svg recommended. Only used when content is collapsed."
        },
        {
          "type": "range",
          "id": "icon_width",
          "min": 16,
          "max": 48,
          "step": 2,
          "unit": "px",
          "label": "Icon width",
          "default": 20
        },
        {
          "type": "checkbox",
          "id": "collapse_content",
          "label": "Collapse content",
          "default": false
        }
      ]
    },
    {
      "type": "variant_picker",
      "name": "Variant picker",
      "limit": 1
    },
    {
      "type": "quantity_selector",
      "name": "Quantity selector",
      "limit": 1
    },
    {
      "type": "buy_buttons",
      "name": "Buy buttons",
      "limit": 1,
      "settings": [
        {
          "type": "checkbox",
          "id": "show_payment_button",
          "label": "Show dynamic checkout button",
          "info": "Each customer will see their preferred payment method from those available on your store, such as PayPal or Apple Pay. [Learn more](https://help.shopify.com/manual/using-themes/change-the-layout/dynamic-checkout)",
          "default": true
        },
        {
          "type": "checkbox",
          "id": "show_gift_card_recipient",
          "label": "Show recipient information form for gift cards",
          "info": "Allow buyers to send gift cards along with a personal message. [Learn more](https://help.shopify.com/manual/online-store/themes/customizing-themes/add-gift-card-recipient-fields)",
          "default": true
        },
        {
          "type": "color",
          "id": "atc_button_background",
          "label": "Add to cart background"
        },
        {
          "type": "color",
          "id": "atc_button_text_color",
          "label": "Add to cart color"
        },
        {
          "type": "color",
          "id": "payment_button_background",
          "label": "Buy now button background"
        },
        {
          "type": "color",
          "id": "payment_button_text_color",
          "label": "Buy now button color"
        }
      ]
    }
  ],
  "settings": [
    {
      "type": "checkbox",
      "id": "full_width",
      "label": "Full width",
      "default": true
    },
    {
      "type": "product",
      "id": "product",
      "label": "Product"
    },
    {
      "type": "header",
      "content": "Media"
    },
    {
      "type": "paragraph",
      "content": "Learn more about [media types](https://help.shopify.com/en/manual/products/product-media)"
    },
    {
      "type": "range",
      "id": "desktop_media_width",
      "label": "Desktop media size",
      "min": 35,
      "max": 65,
      "step": 5,
      "unit": "%",
      "default": 55
    },
    {
      "type": "select",
      "id": "desktop_media_layout",
      "label": "Desktop media layout",
      "options": [
        {
          "value": "grid_one",
          "label": "Grid (1x1)"
        },
        {
          "value": "grid",
          "label": "Grid (2x2)"
        },
        {
          "value": "carousel_thumbnails_left",
          "label": "Thumbnails left (carousel)"
        },
        {
          "value": "carousel_thumbnails_bottom",
          "label": "Thumbnails bottom (carousel)"
        }
      ],
      "default": "carousel_thumbnails_bottom"
    },
    {
      "type":"select",
      "id": "mobile_media_size",
      "label": "Mobile media size",
      "options": [
        {
          "value": "expanded",
          "label": "Expanded"
        },
        {
          "value": "contained",
          "label": "Contained"
        }
      ],
      "default": "contained"
    },
    {
      "type": "select",
      "id": "mobile_carousel_control",
      "label": "Mobile carousel control",
      "options": [
        {
          "value": "dots",
          "label": "Dots"
        },
        {
          "value": "floating_dots",
          "label": "Floating dots"
        },
        {
          "value": "thumbnails",
          "label": "Thumbnails"
        },
        {
          "value": "free_scroll",
          "label": "Free scroll"
        }
      ],
      "default": "thumbnails"
    },
    {
      "type": "checkbox",
      "id": "enable_video_autoplay",
      "label": "Enable video autoplay",
      "info": "Video are muted automatically to allow autoplay. Grid mode on desktop turn off autoplay.",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "enable_video_looping",
      "label": "Enable video looping",
      "default": false
    },
    {
      "type": "checkbox",
      "id": "enable_image_zoom",
      "label": "Enable image zoom",
      "default": true
    },
    {
      "type": "color",
      "id": "background",
      "label": "Background"
    },
    {
      "type": "color",
      "id": "text_color",
      "label": "Text"
    }
  ],
  "presets": [
    {
      "name": "Featured product"
    }
  ]
}
{% endschema %}
