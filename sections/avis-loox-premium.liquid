{% comment %}
  Section : Avis clients premium (Loox style)
{% endcomment %}

<div class="loox-premium-reviews" data-section-id="{{ section.id }}">
  <div class="reviews-container">

    <h2 class="reviews-main-title">
      Découvrez <span class="highlight-text">les avis</span>
    </h2>

    <div class="reviews-header">

      <!-- NOTE -->
      <div class="rating-summary">
        <div class="stars">★★★★★</div>

        <button class="reviews-count js-rating-toggle">
          {{ section.blocks.size }} avis <span>▼</span>
        </button>

        <div class="rating-dropdown js-rating-dropdown">
          <div class="average-score">
            <span class="big-star">★</span>
            <span class="score">{{ section.settings.average_rating }}</span>
          </div>

          <div class="rating-bars">
            {% for i in (5..1) %}
              <div class="rating-row">
                <span class="label">
                  {% for s in (1..5) %}
                    {% if s <= i %}★{% else %}☆{% endif %}
                  {% endfor %}
                </span>

                <div class="bar">
                  <div class="fill"
                    style="width:
                    {% if i == 5 %}{{ section.settings.five_star_percent }}
                    {% elsif i == 4 %}{{ section.settings.four_star_percent }}
                    {% elsif i == 3 %}{{ section.settings.three_star_percent }}
                    {% elsif i == 2 %}{{ section.settings.two_star_percent }}
                    {% else %}{{ section.settings.one_star_percent }}{% endif %}%;">
                  </div>
                </div>

                <span class="count">
                  (
                  {% if i == 5 %}{{ section.settings.five_star_count }}
                  {% elsif i == 4 %}{{ section.settings.four_star_count }}
                  {% elsif i == 3 %}{{ section.settings.three_star_count }}
                  {% elsif i == 2 %}{{ section.settings.two_star_count }}
                  {% else %}{{ section.settings.one_star_count }}{% endif %}
                  )
                </span>
              </div>
            {% endfor %}
          </div>
        </div>
      </div>

      <!-- FILTRE -->
      <div class="filter-wrapper">
        <button class="filter-btn js-filter-toggle">☰</button>

        <div class="filter-dropdown js-filter-dropdown">
          <div class="filter-title">Trier par</div>
          <div class="filter-item active" data-sort="featured">En vedette</div>
          <div class="filter-item" data-sort="recent">Les plus récentes</div>
          <div class="filter-item" data-sort="high">Les meilleures notes</div>
          <div class="filter-item" data-sort="low">Les notes les plus basses</div>
        </div>
      </div>
    </div>

    <!-- AVIS -->
    <div class="reviews-list">
      {% for block in section.blocks %}
        <div class="review-item"
             data-rating="{{ block.settings.rating }}"
             data-date="{{ block.settings.review_date }}"
             {{ block.shopify_attributes }}>

          <div class="content">
            <div class="top">
              <strong>{{ block.settings.customer_name }}</strong>
              {% if block.settings.verified %}
                <span class="verified">✔ Vérifié</span>
              {% endif %}
            </div>

            <div class="date">{{ block.settings.review_date }}</div>

            <div class="stars">
              {% for i in (1..5) %}
                {% if i <= block.settings.rating %}★{% else %}☆{% endif %}
              {% endfor %}
            </div>

            <p>{{ block.settings.review_text }}</p>
          </div>

          {% if block.settings.customer_image %}
            <div class="image">
              <img src="{{ block.settings.customer_image | image_url: width: 300 }}" alt="">
            </div>
          {% endif %}
        </div>
      {% endfor %}
    </div>

  </div>
</div>

<style>
.loox-premium-reviews{padding:60px 0}
.reviews-container{max-width:900px;margin:auto;padding:0 20px}
.reviews-main-title{text-align:center;font-size:32px;margin-bottom:40px}
.highlight-text{color:#00A651;font-weight:700}
.reviews-header{display:flex;justify-content:space-between;gap:20px}
.rating-summary{position:relative}
.stars{color:#FFD700;font-size:28px}
.reviews-count{background:none;border:none;font-weight:600;cursor:pointer}
.rating-dropdown{display:none;position:absolute;top:45px;left:0;background:#f9f9f9;padding:20px;border-radius:10px;width:320px;z-index:10}
.rating-dropdown.active{display:block;animation:fade .25s}
.average-score{display:flex;align-items:center;gap:10px;font-size:36px;font-weight:700}
.big-star{color:#FFD700}
.rating-row{display:flex;align-items:center;gap:10px;margin:6px 0}
.bar{flex:1;height:8px;background:#e0e0e0;border-radius:4px;overflow:hidden}
.fill{height:100%;background:#FFD700}
.filter-wrapper{position:relative}
.filter-btn{border:1px solid #ddd;background:#fff;padding:8px 12px;border-radius:6px;cursor:pointer}
.filter-dropdown{display:none;position:absolute;right:0;top:45px;background:#fff;border:1px solid #ddd;border-radius:10px;padding:10px;width:220px;z-index:10}
.filter-dropdown.active{display:block;animation:fade .25s}
.filter-title{font-weight:700;margin-bottom:10px}
.filter-item{padding:8px;border-radius:6px;cursor:pointer}
.filter-item.active{background:#000;color:#fff}
.reviews-list{margin-top:40px;display:flex;flex-direction:column;gap:30px}
.review-item{border:1px solid #eee;padding:20px;border-radius:14px;display:flex;gap:20px}
.review-item .stars{font-size:18px}
.image{width:150px;height:150px;border-radius:10px;overflow:hidden}
.image img{width:100%;height:100%;object-fit:cover}
@keyframes fade{from{opacity:0;transform:translateY(-5px)}to{opacity:1}}
@media(max-width:768px){
.reviews-header{flex-direction:column}
.review-item{flex-direction:column}
.image{width:100%;height:220px}
}
</style>

<script>
document.addEventListener('DOMContentLoaded',()=>{
  const ratingBtn=document.querySelector('.js-rating-toggle')
  const ratingDrop=document.querySelector('.js-rating-dropdown')
  const filterBtn=document.querySelector('.js-filter-toggle')
  const filterDrop=document.querySelector('.js-filter-dropdown')
  const reviews=[...document.querySelectorAll('.review-item')]
  const list=document.querySelector('.reviews-list')

  ratingBtn.onclick=()=>ratingDrop.classList.toggle('active')
  filterBtn.onclick=()=>filterDrop.classList.toggle('active')

  document.querySelectorAll('.filter-item').forEach(btn=>{
    btn.onclick=()=>{
      document.querySelectorAll('.filter-item').forEach(b=>b.classList.remove('active'))
      btn.classList.add('active')

      let sorted=[...reviews]
      const type=btn.dataset.sort

      if(type==='recent'){
        sorted.sort((a,b)=>new Date(b.dataset.date)-new Date(a.dataset.date))
      }
      if(type==='high'){
        sorted.sort((a,b)=>b.dataset.rating-a.dataset.rating)
      }
      if(type==='low'){
        sorted.sort((a,b)=>a.dataset.rating-b.dataset.rating)
      }

      list.innerHTML=''
      sorted.forEach(r=>list.appendChild(r))
    }
  })

  document.addEventListener('click',e=>{
    if(!e.target.closest('.rating-summary'))ratingDrop.classList.remove('active')
    if(!e.target.closest('.filter-wrapper'))filterDrop.classList.remove('active')
  })
})
</script>

{% schema %}
{
  "name": "Avis clients premium",
  "settings": [
    { "type": "text", "id": "average_rating", "label": "Note moyenne", "default": "4.8" },

    { "type": "number", "id": "five_star_count", "label": "Nombre 5 étoiles", "default": 105 },
    { "type": "range", "id": "five_star_percent", "label": "Pourcentage 5 étoiles", "min": 0, "max": 100, "step": 1, "default": 80 },

    { "type": "number", "id": "four_star_count", "label": "Nombre 4 étoiles", "default": 20 },
    { "type": "range", "id": "four_star_percent", "label": "Pourcentage 4 étoiles", "min": 0, "max": 100, "step": 1, "default": 15 },

    { "type": "number", "id": "three_star_count", "label": "Nombre 3 étoiles", "default": 2 },
    { "type": "range", "id": "three_star_percent", "label": "Pourcentage 3 étoiles", "min": 0, "max": 100, "step": 1, "default": 3 },

    { "type": "number", "id": "two_star_count", "label": "Nombre 2 étoiles", "default": 1 },
    { "type": "range", "id": "two_star_percent", "label": "Pourcentage 2 étoiles", "min": 0, "max": 100, "step": 1, "default": 1 },

    { "type": "number", "id": "one_star_count", "label": "Nombre 1 étoile", "default": 1 },
    { "type": "range", "id": "one_star_percent", "label": "Pourcentage 1 étoile", "min": 0, "max": 100, "step": 1, "default": 1 }
  ],
  "blocks": [
    {
      "type": "review",
      "name": "Avis",
      "settings": [
        { "type": "text", "id": "customer_name", "label": "Nom", "default": "Client" },
        { "type": "checkbox", "id": "verified", "label": "Vérifié", "default": true },
        { "type": "text", "id": "review_date", "label": "Date", "default": "2025-01-01" },
        { "type": "range", "id": "rating", "label": "Note", "min": 1, "max": 5, "step": 1, "default": 5 },
        { "type": "textarea", "id": "review_text", "label": "Avis" },
        { "type": "image_picker", "id": "customer_image", "label": "Image client" }
      ]
    }
  ],
  "presets": [
    { "name": "Avis clients premium" }
  ]
}
{% endschema %}
