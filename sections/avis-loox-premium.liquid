{% comment %}
SECTION : Avis clients premium â€“ version finale corrigÃ©e
{% endcomment %}

{% assign five_star_percent_number = section.settings.five_star_percent | plus: 0 %}

<div class="reviews-premium" id="avis-clients" data-reviews-section>
  <div class="reviews-container">

    <h2 class="reviews-title">
      Ce que les propriÃ©taires dâ€™animaux en pensent
    </h2>

    <!-- RÃ‰SUMÃ‰ -->
    <div class="rating-summary">
      <button class="rating-toggle js-rating-toggle">
        <span class="stars">â˜…â˜…â˜…â˜…â˜…</span>
        <span class="count">{{ section.blocks.size }} clients satisfaits</span>
        <span class="chevron">â€º</span>
      </button>

      <!-- DROPDOWN -->
      <div class="rating-dropdown js-rating-dropdown">

        <div class="average-score">
          â˜… {{ section.settings.average_rating }}
        </div>

        {% if five_star_percent_number >= 70 %}
          <div class="top-badge">
            La majoritÃ© des clients donnent 5 Ã©toiles
          </div>
        {% endif %}

        <div class="rating-bars">

          {% assign rows = "5,five_star_percent,five_star_count|4,four_star_percent,four_star_count|3,three_star_percent,three_star_count|2,two_star_percent,two_star_count|1,one_star_percent,one_star_count" | split: "|" %}

          {% for row in rows %}
            {% assign p = row | split: "," %}
            {% assign stars_number = p[0] | plus: 0 %}
            {% assign percent_value = section.settings[p[1]] | plus: 0 %}

            <div class="rating-row rating-{{ stars_number }}" data-width="{{ percent_value }}">
              <span class="label">
                {% for i in (1..5) %}
                  {% if i <= stars_number %}â˜…{% else %}â˜†{% endif %}
                {% endfor %}
              </span>

              <div class="bar">
                <div class="fill"></div>
              </div>

              <span class="number">
                ({{ section.settings[p[2]] }})
              </span>
            </div>
          {% endfor %}

        </div>
      </div>
    </div>

    <!-- CTA -->
    <a href="#avis-clients" class="write-review-btn">
      Partager mon expÃ©rience
    </a>

    <!-- AVIS -->
    <div class="reviews-list">
      {% for block in section.blocks %}
        <div class="review-item" {{ block.shopify_attributes }}>
          <div class="review-stars">
            {% for i in (1..5) %}
              {% if i <= block.settings.rating %}â˜…{% else %}â˜†{% endif %}
            {% endfor %}
          </div>

          <p class="review-text">{{ block.settings.review_text }}</p>

          <div class="review-footer">
            <strong>{{ block.settings.customer_name }}</strong>
            {% if block.settings.verified %}
              <span class="verified">âœ” Achat vÃ©rifiÃ©</span>
            {% endif %}
          </div>
        </div>
      {% endfor %}
    </div>

  </div>
</div>

<!-- STICKY MOBILE -->
<div class="mobile-rating-bar">
  <span class="stars">â˜…â˜…â˜…â˜…â˜…</span>
  <span class="rating-text">
    {{ section.settings.average_rating }} Â· {{ section.blocks.size }} clients satisfaits
  </span>
</div>

<style>
.reviews-premium{padding:20px 0;background:#fff}
.reviews-container{max-width:1100px;margin:auto;padding:0 20px}
.reviews-title{text-align:center;font-size:32px;margin-bottom:30px}

.rating-toggle{display:flex;align-items:center;gap:8px;background:none;border:none;cursor:pointer}
.stars{color:#FFD700;font-size:22px}
.chevron{font-size:18px}

.rating-dropdown{display:none;margin-top:12px;background:#f9f9f9;padding:20px;border-radius:14px;max-width:420px}
.rating-dropdown.active{display:block}
.average-score{font-size:36px;font-weight:700}
.top-badge{margin-top:6px;background:#00A651;color:#fff;font-size:12px;padding:6px 12px;border-radius:20px}

.rating-row{display:flex;align-items:center;gap:10px;margin:8px 0}
.bar{flex:1;height:8px;background:#ddd;border-radius:4px;overflow:hidden}
.fill{height:100%;width:0;transition:width .6s ease}
.rating-5 .fill{background:#00A651}
.rating-4 .fill{background:#6BCF9B}
.rating-3 .fill{background:#F4C430}
.rating-2 .fill{background:#F39C12}
.rating-1 .fill{background:#E74C3C}

.write-review-btn{display:block;margin:30px auto;border:2px solid #000;padding:14px 30px;border-radius:8px;text-decoration:none;color:#000;font-weight:600;width:max-content}

.reviews-list{display:flex;gap:20px;overflow-x:auto;padding-bottom:10px}
.review-item{min-width:280px;border:1px solid #eee;border-radius:14px;padding:20px}
.review-stars{color:#FFD700;font-size:18px;margin-bottom:10px}
.review-text{font-size:15px;line-height:1.5;margin-bottom:12px}
.verified{color:#00A651;font-size:12px;margin-left:6px}

@media (max-width:768px){
  .reviews-premium{padding:16px 0}
  .mobile-rating-bar{
  position:fixed;
  bottom:64px;
  left:50%;
  transform:translateX(-50%);
  background:#fff;
  padding:8px 14px;
  border-radius:999px;
  box-shadow:0 4px 12px rgba(0,0,0,.12);
  display:none;
  align-items:center;
  gap:6px;
  z-index:60;
  white-space:nowrap;   /* ðŸ”¥ FORCE UNE SEULE LIGNE */
  max-width:90vw;
}

}
</style>

<script>
document.addEventListener('DOMContentLoaded',()=>{
  const toggle=document.querySelector('.js-rating-toggle')
  const dropdown=document.querySelector('.js-rating-dropdown')
  const sticky=document.querySelector('.mobile-rating-bar')
  const section=document.querySelector('[data-reviews-section]')

  if(toggle){
    toggle.addEventListener('click',()=>{
      dropdown.classList.toggle('active')
      dropdown.querySelectorAll('.rating-row').forEach(row=>{
        row.querySelector('.fill').style.width=row.dataset.width+'%'
      })
    })
  }

  if(sticky && section){
    const observer=new IntersectionObserver(
      ([entry])=>sticky.style.display=entry.isIntersecting?'none':'flex',
      {threshold:0.2}
    )
    observer.observe(section)
  }
})
</script>

{% schema %}
{
  "name": "Avis clients premium",
  "settings": [
    { "type": "text", "id": "average_rating", "label": "Note moyenne", "default": "4.6" },
    { "type": "number", "id": "five_star_count", "label": "Nombre 5 Ã©toiles", "default": 105 },
    { "type": "range", "id": "five_star_percent", "label": "Pourcentage 5 Ã©toiles", "min": 0, "max": 100, "step": 1, "default": 80 },
    { "type": "number", "id": "four_star_count", "label": "Nombre 4 Ã©toiles", "default": 20 },
    { "type": "range", "id": "four_star_percent", "label": "Pourcentage 4 Ã©toiles", "min": 0, "max": 100, "step": 1, "default": 15 },
    { "type": "number", "id": "three_star_count", "label": "Nombre 3 Ã©toiles", "default": 2 },
    { "type": "range", "id": "three_star_percent", "label": "Pourcentage 3 Ã©toiles", "min": 0, "max": 100, "step": 1, "default": 3 },
    { "type": "number", "id": "two_star_count", "label": "Nombre 2 Ã©toiles", "default": 1 },
    { "type": "range", "id": "two_star_percent", "label": "Pourcentage 2 Ã©toiles", "min": 0, "max": 100, "step": 1, "default": 1 },
    { "type": "number", "id": "one_star_count", "label": "Nombre 1 Ã©toile", "default": 1 },
    { "type": "range", "id": "one_star_percent", "label": "Pourcentage 1 Ã©toile", "min": 0, "max": 100, "step": 1, "default": 1 }
  ],
  "blocks": [
    {
      "type": "review",
      "name": "Avis",
      "settings": [
        { "type": "text", "id": "customer_name", "label": "Nom" },
        { "type": "checkbox", "id": "verified", "label": "Achat vÃ©rifiÃ©", "default": true },
        { "type": "range", "id": "rating", "label": "Note", "min": 1, "max": 5, "step": 1, "default": 5 },
        { "type": "textarea", "id": "review_text", "label": "Avis" }
      ]
    }
  ],
  "presets": [
    { "name": "Avis clients premium" }
  ]
}
{% endschema %}
