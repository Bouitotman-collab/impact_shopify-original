{% comment %}
SECTION : Tous les avis clients – Solution simple sans limite
{% endcomment %}

{% assign all_reviews = shop.metaobjects.review.values %}

<div class="all-reviews" id="tous-les-avis">
  <div class="all-reviews-container">

    <h2 class="all-reviews-title">Tous les avis clients</h2>

    <p class="all-reviews-subtitle">
      Chargement des avis...
    </p>

    <div class="all-reviews-list" id="reviewsList">
    </div>

    <div class="load-more-container" id="loadMoreContainer" style="display:none;">
      <button class="load-more-btn" id="loadMoreReviews">
        Charger plus
      </button>
    </div>

  </div>
</div>

<!-- Liste cachée avec TOUS les avis -->
<div style="display:none;" id="allReviewsData">
{% for review in all_reviews limit:500 %}
  <div class="review-data" 
       data-nom="{{ review.nom.value | escape }}"
       data-avis="{{ review.avis.value | escape }}"
       data-note="{{ review.note.value }}"
       data-verifie="{{ review.achat_verifie.value }}">
  </div>
{% endfor %}
</div>

<style>
.all-reviews{padding:48px 0;background:#fafafa}
.all-reviews-container{max-width:900px;margin:auto;padding:0 20px}
.all-reviews-title{text-align:center;font-size:30px;margin-bottom:10px}
.all-reviews-subtitle{text-align:center;font-size:15px;color:#666;margin-bottom:40px}

.all-reviews-list{
  display:flex;
  flex-direction:column;
  gap:22px;
}

.all-review-item{
  background:#fff;
  border:1px solid #e5e5e5;
  border-radius:14px;
  padding:22px;
}

.all-review-stars{color:#FFD700;font-size:18px;margin-bottom:10px}
.all-review-text{font-size:15px;line-height:1.6;margin-bottom:12px}
.all-review-footer{font-size:14px;color:#555}
.verified{color:#00A651;font-size:12px;margin-left:6px}

.load-more-container{text-align:center;margin-top:40px}
.load-more-btn{
  padding:12px 30px;
  border:2px solid #000;
  border-radius:8px;
  background:#fff;
  font-weight:600;
  cursor:pointer;
}
</style>

<script>
(function() {
  const reviewsData = document.querySelectorAll('.review-data');
  const container = document.getElementById('reviewsList');
  const subtitle = document.querySelector('.all-reviews-subtitle');
  const loadMoreBtn = document.getElementById('loadMoreContainer');
  
  let visible = 12;
  let allReviews = [];

  // Extraire les données
  reviewsData.forEach(item => {
    allReviews.push({
      nom: item.getAttribute('data-nom'),
      avis: item.getAttribute('data-avis'),
      note: parseInt(item.getAttribute('data-note')) || 5,
      verifie: item.getAttribute('data-verifie') === 'true'
    });
  });

  // Fonction pour afficher les étoiles
  function renderStars(note) {
    let stars = '';
    for (let i = 1; i <= 5; i++) {
      stars += i <= note ? '★' : '☆';
    }
    return stars;
  }

  // Afficher les avis
  function renderReviews() {
    container.innerHTML = '';
    
    allReviews.slice(0, visible).forEach(review => {
      const div = document.createElement('div');
      div.className = 'all-review-item';
      
      div.innerHTML = `
        <div class="all-review-stars">
          ${renderStars(review.note)}
        </div>
        <p class="all-review-text">
          ${review.avis}
        </p>
        <div class="all-review-footer">
          <strong>${review.nom}</strong>
          ${review.verifie ? '<span class="verified">✔ Achat vérifié</span>' : ''}
        </div>
      `;
      
      container.appendChild(div);
    });

    // Mettre à jour le compteur
    subtitle.textContent = `${allReviews.length} avis laissés par plus de {{ section.settings.total_customers }} clients`;

    // Afficher le bouton si nécessaire
    if (visible < allReviews.length) {
      loadMoreBtn.style.display = 'block';
    } else {
      loadMoreBtn.style.display = 'none';
    }
  }

  // Bouton charger plus
  document.getElementById('loadMoreReviews').addEventListener('click', () => {
    visible += 12;
    renderReviews();
  });

  // Afficher au chargement
  renderReviews();
})();
</script>

{% schema %}
{
  "name": "Tous les avis clients",
  "settings": [
    {
      "type": "number",
      "id": "total_customers",
      "label": "Nombre total de clients",
      "default": 1800
    }
  ],
  "presets": [
    {
      "name": "Tous les avis clients"
    }
  ]
}
{% endschema %}