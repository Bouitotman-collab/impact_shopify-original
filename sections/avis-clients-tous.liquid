{% comment %}
SECTION : Tous les avis clients – Version Production (Sécurisée + Optimisée + SEO)
{% endcomment %}

<div class="all-reviews" id="tous-les-avis">
  <div class="all-reviews-container">

    <h2 class="all-reviews-title">Tous les avis clients</h2>

    <p class="all-reviews-subtitle">
      Noté 4,8/5 par 129 clients vérifiés
    </p>

    <!-- SEO Fallback (invisible utilisateur, visible Google) -->
    <div style="position:absolute;left:-9999px;width:1px;height:1px;overflow:hidden;" aria-hidden="true">
      129 avis clients vérifiés avec note moyenne 4.8 étoiles sur 5. Produit tablettes nettoyantes lave-linge très efficace contre poils animaux, odeurs incrustées et résidus. Clients satisfaits recommandent pour entretien mensuel machine à laver avec chien chat. Élimine mauvaises odeurs, nettoie tambour filtre en profondeur, prévient encrassement bouchons.
    </div>

    <div class="all-reviews-list" id="reviewsList">
      <!-- 12 premiers avis en HTML pur pour SEO et performance -->
      <div class="all-review-item">
        <div class="all-review-stars">★★★★★</div>
        <p class="all-review-text">Bon entretien pour prévenir les pannes.</p>
        <div class="all-review-footer">
          <strong>Vincent G.</strong>
          <span class="verified">✔ Achat vérifié</span>
        </div>
      </div>

      <div class="all-review-item">
        <div class="all-review-stars">★★★★☆</div>
        <p class="all-review-text">Résultat correct sur les résidus.</p>
        <div class="all-review-footer">
          <strong>Sandrine M.</strong>
          <span class="verified">✔ Achat vérifié</span>
        </div>
      </div>

      <div class="all-review-item">
        <div class="all-review-stars">★★★★★</div>
        <p class="all-review-text">Utilisation simple, résultat visible.</p>
        <div class="all-review-footer">
          <strong>Camille S.</strong>
          <span class="verified">✔ Achat vérifié</span>
        </div>
      </div>

      <div class="all-review-item">
        <div class="all-review-stars">★★★★★</div>
        <p class="all-review-text">Lave-linge plus propre après chaque cycle.</p>
        <div class="all-review-footer">
          <strong>Pierre D.</strong>
          <span class="verified">✔ Achat vérifié</span>
        </div>
      </div>

      <div class="all-review-item">
        <div class="all-review-stars">★★★★☆</div>
        <p class="all-review-text">Les poils sont moins présents après nettoyage.</p>
        <div class="all-review-footer">
          <strong>Benoît F.</strong>
          <span class="verified">✔ Achat vérifié</span>
        </div>
      </div>

      <div class="all-review-item">
        <div class="all-review-stars">★★★★★</div>
        <p class="all-review-text">Très efficace sur les résidus.</p>
        <div class="all-review-footer">
          <strong>Élodie V.</strong>
          <span class="verified">✔ Achat vérifié</span>
        </div>
      </div>

      <div class="all-review-item">
        <div class="all-review-stars">★★★★★</div>
        <p class="all-review-text">Les poils ne bouchent plus le filtre.</p>
        <div class="all-review-footer">
          <strong>Adrien T.</strong>
          <span class="verified">✔ Achat vérifié</span>
        </div>
      </div>

      <div class="all-review-item">
        <div class="all-review-stars">★★★★☆</div>
        <p class="all-review-text">Nettoie bien la machine, bon produit.</p>
        <div class="all-review-footer">
          <strong>Isabelle T.</strong>
          <span class="verified">✔ Achat vérifié</span>
        </div>
      </div>

      <div class="all-review-item">
        <div class="all-review-stars">★★★★★</div>
        <p class="all-review-text">Bon nettoyage sans effort.</p>
        <div class="all-review-footer">
          <strong>Sophie R.</strong>
          <span class="verified">✔ Achat vérifié</span>
        </div>
      </div>

      <div class="all-review-item">
        <div class="all-review-stars">★★★★★</div>
        <p class="all-review-text">La machine fonctionne mieux.</p>
        <div class="all-review-footer">
          <strong>Loïc M.</strong>
          <span class="verified">✔ Achat vérifié</span>
        </div>
      </div>

      <div class="all-review-item">
        <div class="all-review-stars">★★★★☆</div>
        <p class="all-review-text">Bon entretien, fait le travail.</p>
        <div class="all-review-footer">
          <strong>Thomas V.</strong>
          <span class="verified">✔ Achat vérifié</span>
        </div>
      </div>

      <div class="all-review-item">
        <div class="all-review-stars">★★★★★</div>
        <p class="all-review-text">Les dépôts sont bien éliminés.</p>
        <div class="all-review-footer">
          <strong>Karine L.</strong>
          <span class="verified">✔ Achat vérifié</span>
        </div>
      </div>
    </div>

    <div class="load-more-container" id="loadMoreContainer">
      <button class="load-more-btn" id="loadMoreReviews">
        Charger plus
      </button>
    </div>

  </div>
</div>

<style>
.all-reviews{padding:48px 0;background:#fafafa}
.all-reviews-container{max-width:900px;margin:auto;padding:0 20px}
.all-reviews-title{text-align:center;font-size:30px;margin-bottom:10px}
.all-reviews-subtitle{text-align:center;font-size:15px;color:#666;margin-bottom:40px}

.all-reviews-list{
  display:flex;
  flex-direction:column;
  gap:22px;
}

.all-review-item{
  background:#fff;
  border:1px solid #e5e5e5;
  border-radius:14px;
  padding:22px;
}

.all-review-stars{color:#FFD700;font-size:18px;margin-bottom:10px}
.all-review-text{font-size:15px;line-height:1.6;margin-bottom:12px}
.all-review-footer{font-size:14px;color:#555}
.verified{color:#00A651;font-size:12px;margin-left:6px}

.load-more-container{text-align:center;margin-top:40px}
.load-more-btn{
  padding:12px 30px;
  border:2px solid #000;
  border-radius:8px;
  background:#fff;
  font-weight:600;
  cursor:pointer;
}
</style>

<!-- Charger le fichier JS externe -->
<script src="{{ 'reviews-data.js' | asset_url }}" defer></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Attendre que reviews-data.js soit chargé
  if (typeof window.reviewsData === 'undefined') {
    console.error('Reviews data not loaded');
    return;
  }

  const container = document.getElementById('reviewsList');
  const loadMoreBtn = document.getElementById('loadMoreContainer');
  let currentIndex = 12;

  // ✅ Fonction d'échappement HTML (Sécurité XSS)
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  // ✅ Génération des étoiles
  function renderStars(note) {
    let stars = '';
    for (let i = 1; i <= 5; i++) {
      stars += i <= note ? '★' : '☆';
    }
    return stars;
  }

  // ✅ Chargement de 12 avis supplémentaires
  function loadMoreReviews() {
    const reviewsToLoad = window.reviewsData.slice(currentIndex - 12, currentIndex - 12 + 12);
    
    reviewsToLoad.forEach(review => {
      const div = document.createElement('div');
      div.className = 'all-review-item';
      
      // ✅ SÉCURISÉ : échappement HTML sur l'avis
      div.innerHTML = `
        <div class="all-review-stars">
          ${renderStars(review.note)}
        </div>
        <p class="all-review-text">
          ${escapeHtml(review.avis)}
        </p>
        <div class="all-review-footer">
          <strong>${escapeHtml(review.nom)}</strong>
          ${review.achat_verifie ? '<span class="verified">✔ Achat vérifié</span>' : ''}
        </div>
      `;
      
      container.appendChild(div);
    });

    currentIndex += 12;

    // Cacher le bouton si tous les avis sont affichés
    if (currentIndex >= 129) {
      loadMoreBtn.style.display = 'none';
    }
  }

  // ✅ Event listener sur le bouton
  document.getElementById('loadMoreReviews').addEventListener('click', loadMoreReviews);
});
</script>

{% schema %}
{
  "name": "Tous les avis clients",
  "settings": [
    {
      "type": "number",
      "id": "total_customers",
      "label": "Nombre total de clients",
      "default": 1800
    }
  ],
  "presets": [
    {
      "name": "Tous les avis clients"
    }
  ]
}
{% endschema %}